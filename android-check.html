<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•ˆë“œë¡œì´ë“œ Share Target ì§„ë‹¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 15px;
            font-size: 14px;
        }
        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { font-size: 20px; margin-bottom: 15px; color: #333; }
        h2 { font-size: 16px; margin: 15px 0 10px; color: #2196F3; }
        .item {
            padding: 10px;
            margin: 8px 0;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #ddd;
        }
        .item.ok { border-left-color: #4CAF50; background: #f1f8f4; }
        .item.fail { border-left-color: #f44336; background: #ffebee; }
        .item.warn { border-left-color: #ff9800; background: #fff3e0; }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        .status.ok { background: #4CAF50; color: white; }
        .status.fail { background: #f44336; color: white; }
        .status.warn { background: #ff9800; color: white; }
        pre {
            background: #263238;
            color: #aed581;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            line-height: 1.4;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        .highlight {
            background: yellow;
            padding: 2px 4px;
            font-weight: bold;
        }
        .critical {
            background: #ffcdd2;
            border: 2px solid #f44336;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .success {
            background: #c8e6c9;
            border: 2px solid #4CAF50;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ì•ˆë“œë¡œì´ë“œ Share Target ì§„ë‹¨</h1>
        
        <div id="platform-check"></div>
        <div id="install-check"></div>
        <div id="manifest-check"></div>
        <div id="icon-check"></div>
        <div id="sw-check"></div>
        <div id="final-verdict"></div>

        <h2>ğŸ› ï¸ ì¡°ì¹˜ ë°©ë²•</h2>
        <div id="actions"></div>
        
        <h2>ğŸ“‹ ìƒì„¸ ì •ë³´</h2>
        <button onclick="copyDiagnostics()">ì§„ë‹¨ ì •ë³´ ë³µì‚¬</button>
        <button onclick="location.reload()">ë‹¤ì‹œ ì§„ë‹¨</button>
        <pre id="details"></pre>
    </div>

    <script>
        const diagnostics = {
            platform: '',
            isAndroid: false,
            isChrome: false,
            chromeVersion: 0,
            isInstalled: false,
            manifestOk: false,
            iconsOk: false,
            swOk: false,
            errors: [],
            warnings: []
        };

        async function runDiagnostics() {
            checkPlatform();
            await checkInstallation();
            await checkManifest();
            await checkIcons();
            await checkServiceWorker();
            showFinalVerdict();
            showActions();
            showDetails();
        }

        function checkPlatform() {
            const ua = navigator.userAgent;
            diagnostics.platform = ua;
            diagnostics.isAndroid = /Android/i.test(ua);
            diagnostics.isChrome = /Chrome/i.test(ua) && !/Edge/i.test(ua);
            
            const match = ua.match(/Chrome\/(\d+)/);
            diagnostics.chromeVersion = match ? parseInt(match[1]) : 0;

            const div = document.getElementById('platform-check');
            let html = '<h2>1ï¸âƒ£ í”Œë«í¼ í™•ì¸</h2>';

            if (!diagnostics.isAndroid) {
                html += `<div class="item fail">
                    âŒ Androidê°€ ì•„ë‹™ë‹ˆë‹¤<span class="status fail">CRITICAL</span>
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    Share Target APIëŠ” <span class="highlight">Androidë§Œ</span> ì§€ì›í•©ë‹ˆë‹¤. iOS, PCì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </div>
                </div>`;
                diagnostics.errors.push('í”Œë«í¼ì´ Androidê°€ ì•„ë‹˜');
            } else {
                html += `<div class="item ok">âœ… Android ê°ì§€ë¨<span class="status ok">OK</span></div>`;
            }

            if (!diagnostics.isChrome) {
                html += `<div class="item fail">
                    âŒ Chromeì´ ì•„ë‹™ë‹ˆë‹¤<span class="status fail">CRITICAL</span>
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    Samsung Internet, Firefox ë“±ì€ ë¯¸ì§€ì›. <span class="highlight">Chrome ì‚¬ìš© í•„ìˆ˜</span>
                    </div>
                </div>`;
                diagnostics.errors.push('Chrome ë¸Œë¼ìš°ì €ê°€ ì•„ë‹˜');
            } else {
                html += `<div class="item ok">âœ… Chrome ê°ì§€ë¨<span class="status ok">OK</span></div>`;
            }

            if (diagnostics.chromeVersion < 84) {
                html += `<div class="item fail">
                    âŒ Chrome ë²„ì „: ${diagnostics.chromeVersion}<span class="status fail">CRITICAL</span>
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    Chrome 84 ì´ìƒ í•„ìš”. í˜„ì¬: <span class="highlight">${diagnostics.chromeVersion}</span>
                    </div>
                </div>`;
                diagnostics.errors.push(`Chrome ë²„ì „ ë¶€ì¡± (${diagnostics.chromeVersion} < 84)`);
            } else {
                html += `<div class="item ok">âœ… Chrome ë²„ì „: ${diagnostics.chromeVersion}<span class="status ok">OK</span></div>`;
            }

            div.innerHTML = html;
        }

        async function checkInstallation() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                                 window.navigator.standalone ||
                                 document.referrer.includes('android-app://');

            diagnostics.isInstalled = isStandalone;

            const div = document.getElementById('install-check');
            let html = '<h2>2ï¸âƒ£ ì„¤ì¹˜ ìƒíƒœ</h2>';

            if (!isStandalone) {
                html += `<div class="item fail">
                    âŒ PWAê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ<span class="status fail">CRITICAL</span>
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    ì£¼ì†Œì°½ì´ ë³´ì¸ë‹¤ë©´ = PWA ì„¤ì¹˜ ì•ˆë¨.<br>
                    <span class="highlight">ë°˜ë“œì‹œ "ì•± ì„¤ì¹˜"</span>ë¥¼ í•´ì•¼ ê³µìœ  íƒ€ê²Ÿì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                    </div>
                </div>`;
                diagnostics.errors.push('PWA ë¯¸ì„¤ì¹˜ (Standalone ëª¨ë“œ ì•„ë‹˜)');
            } else {
                html += `<div class="item ok">âœ… PWA ì„¤ì¹˜ë¨ (Standalone ëª¨ë“œ)<span class="status ok">OK</span></div>`;
            }

            div.innerHTML = html;
        }

        async function checkManifest() {
            const div = document.getElementById('manifest-check');
            let html = '<h2>3ï¸âƒ£ Manifest í™•ì¸</h2>';

            try {
                const response = await fetch('/manifest.json');
                const manifest = await response.json();

                const checks = [
                    { name: 'name í•„ë“œ', ok: !!manifest.name },
                    { name: 'short_name í•„ë“œ', ok: !!manifest.short_name },
                    { name: 'start_url í•„ë“œ', ok: !!manifest.start_url },
                    { name: 'display: standalone', ok: manifest.display === 'standalone' },
                    { name: 'icons ë°°ì—´', ok: Array.isArray(manifest.icons) && manifest.icons.length > 0 },
                    { name: '192x192 ì•„ì´ì½˜', ok: manifest.icons.some(i => i.sizes === '192x192') },
                    { name: '512x512 ì•„ì´ì½˜', ok: manifest.icons.some(i => i.sizes === '512x512') },
                    { name: 'share_target ì •ì˜', ok: !!manifest.share_target },
                    { name: 'share_target.action', ok: manifest.share_target?.action === '/share' },
                    { name: 'share_target.method = POST', ok: manifest.share_target?.method === 'POST' },
                    { name: 'share_target.enctype', ok: manifest.share_target?.enctype === 'multipart/form-data' },
                    { name: 'share_target.params.files', ok: Array.isArray(manifest.share_target?.params?.files) }
                ];

                diagnostics.manifestOk = checks.every(c => c.ok);

                checks.forEach(check => {
                    if (check.ok) {
                        html += `<div class="item ok">âœ… ${check.name}<span class="status ok">OK</span></div>`;
                    } else {
                        html += `<div class="item fail">âŒ ${check.name}<span class="status fail">FAIL</span></div>`;
                        diagnostics.errors.push(`Manifest: ${check.name} ì‹¤íŒ¨`);
                    }
                });

            } catch (err) {
                html += `<div class="item fail">âŒ Manifest ë¡œë“œ ì‹¤íŒ¨<span class="status fail">CRITICAL</span></div>`;
                diagnostics.errors.push(`Manifest ë¡œë“œ ì˜¤ë¥˜: ${err.message}`);
            }

            div.innerHTML = html;
        }

        async function checkIcons() {
            const div = document.getElementById('icon-check');
            let html = '<h2>4ï¸âƒ£ ì•„ì´ì½˜ í™•ì¸</h2>';

            const icons = [
                { url: '/icon-192x192.png', size: '192x192' },
                { url: '/icon-512x512.png', size: '512x512' }
            ];

            let allOk = true;

            for (const icon of icons) {
                try {
                    const response = await fetch(icon.url, { method: 'HEAD' });
                    if (response.ok) {
                        html += `<div class="item ok">âœ… ${icon.size} ì•„ì´ì½˜<span class="status ok">OK</span></div>`;
                    } else {
                        html += `<div class="item fail">âŒ ${icon.size} ì•„ì´ì½˜ (${response.status})<span class="status fail">FAIL</span></div>`;
                        diagnostics.errors.push(`ì•„ì´ì½˜ ${icon.size} ë¡œë“œ ì‹¤íŒ¨ (HTTP ${response.status})`);
                        allOk = false;
                    }
                } catch (err) {
                    html += `<div class="item fail">âŒ ${icon.size} ì•„ì´ì½˜ (ì˜¤ë¥˜)<span class="status fail">FAIL</span></div>`;
                    diagnostics.errors.push(`ì•„ì´ì½˜ ${icon.size} ì˜¤ë¥˜: ${err.message}`);
                    allOk = false;
                }
            }

            diagnostics.iconsOk = allOk;
            div.innerHTML = html;
        }

        async function checkServiceWorker() {
            const div = document.getElementById('sw-check');
            let html = '<h2>5ï¸âƒ£ Service Worker í™•ì¸</h2>';

            if (!('serviceWorker' in navigator)) {
                html += `<div class="item fail">âŒ Service Worker ë¯¸ì§€ì›<span class="status fail">CRITICAL</span></div>`;
                diagnostics.errors.push('Service Worker ë¯¸ì§€ì›');
                diagnostics.swOk = false;
                div.innerHTML = html;
                return;
            }

            try {
                const registration = await navigator.serviceWorker.getRegistration();
                
                if (!registration) {
                    html += `<div class="item fail">âŒ Service Worker ë¯¸ë“±ë¡<span class="status fail">CRITICAL</span></div>`;
                    diagnostics.errors.push('Service Worker ë¯¸ë“±ë¡');
                    diagnostics.swOk = false;
                } else {
                    html += `<div class="item ok">âœ… Service Worker ë“±ë¡ë¨<span class="status ok">OK</span></div>`;
                    
                    if (registration.active) {
                        html += `<div class="item ok">âœ… Active ìƒíƒœ<span class="status ok">OK</span></div>`;
                    } else {
                        html += `<div class="item fail">âŒ Active ì•„ë‹˜<span class="status fail">FAIL</span></div>`;
                        diagnostics.errors.push('Service Workerê°€ Active ìƒíƒœ ì•„ë‹˜');
                    }

                    diagnostics.swOk = !!registration.active;
                }
            } catch (err) {
                html += `<div class="item fail">âŒ í™•ì¸ ì˜¤ë¥˜<span class="status fail">FAIL</span></div>`;
                diagnostics.errors.push(`Service Worker í™•ì¸ ì˜¤ë¥˜: ${err.message}`);
                diagnostics.swOk = false;
            }

            div.innerHTML = html;
        }

        function showFinalVerdict() {
            const div = document.getElementById('final-verdict');
            
            const allOk = diagnostics.isAndroid && 
                         diagnostics.isChrome && 
                         diagnostics.chromeVersion >= 84 &&
                         diagnostics.isInstalled &&
                         diagnostics.manifestOk &&
                         diagnostics.iconsOk &&
                         diagnostics.swOk;

            if (allOk) {
                div.innerHTML = `
                    <div class="success">
                        <h2 style="color: #2e7d32;">âœ… ëª¨ë“  ì¡°ê±´ ì¶©ì¡±!</h2>
                        <p style="margin-top: 10px;">
                        ê°¤ëŸ¬ë¦¬ ë“±ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê³µìœ í•  ë•Œ <span class="highlight">"SharePWA"</span>ê°€ ëª©ë¡ì— ë‚˜íƒ€ë‚˜ì•¼ í•©ë‹ˆë‹¤.
                        </p>
                        <p style="margin-top: 10px; font-size: 13px;">
                        ë§Œì•½ ì—¬ì „íˆ ì•ˆ ë³´ì¸ë‹¤ë©´:<br>
                        1. PWA ì™„ì „íˆ ì‚­ì œ<br>
                        2. ì•ˆë“œë¡œì´ë“œ ì¬ë¶€íŒ…<br>
                        3. PWA ì¬ì„¤ì¹˜
                        </p>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="critical">
                        <h2 style="color: #c62828;">âŒ ë¬¸ì œ ë°œê²¬: ${diagnostics.errors.length}ê°œ</h2>
                        <p style="margin-top: 10px;">ì•„ë˜ ì¡°ì¹˜ ë°©ë²•ì„ ë”°ë¼ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”.</p>
                    </div>
                `;
            }
        }

        function showActions() {
            const div = document.getElementById('actions');
            let html = '';

            if (!diagnostics.isAndroid) {
                html += `
                    <div class="item fail">
                        <strong>ğŸš« Android ê¸°ê¸°ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”</strong><br>
                        Share Target APIëŠ” Androidì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤. iOS, Windows, Macì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </div>
                `;
            }

            if (!diagnostics.isChrome || diagnostics.chromeVersion < 84) {
                html += `
                    <div class="item fail">
                        <strong>ğŸ“± Chrome ì—…ë°ì´íŠ¸</strong><br>
                        1. Play Store ì•± ì‹¤í–‰<br>
                        2. "Chrome" ê²€ìƒ‰<br>
                        3. "ì—…ë°ì´íŠ¸" í´ë¦­
                    </div>
                `;
            }

            if (!diagnostics.isInstalled) {
                html += `
                    <div class="item fail">
                        <strong>âš ï¸ PWA ì„¤ì¹˜ ë°©ë²• (ì¤‘ìš”!)</strong><br>
                        1. Chromeì—ì„œ https://pevjant.github.io ì ‘ì†<br>
                        2. ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ ë <span class="highlight">"ì„¤ì¹˜"</span> ì•„ì´ì½˜ í´ë¦­<br>
                        3. "ì„¤ì¹˜" ë²„íŠ¼ í´ë¦­ (â€» "í™ˆ í™”ë©´ì— ì¶”ê°€"ê°€ ì•„ë‹˜!)<br>
                        4. í™ˆ í™”ë©´ì—ì„œ ì•± ì‹¤í–‰í•˜ì—¬ ì£¼ì†Œì°½ì´ ì—†ëŠ”ì§€ í™•ì¸
                    </div>
                `;
            }

            if (!diagnostics.manifestOk || !diagnostics.iconsOk) {
                html += `
                    <div class="item warn">
                        <strong>ğŸ”§ ê°œë°œì ìˆ˜ì • í•„ìš”</strong><br>
                        Manifest ë˜ëŠ” ì•„ì´ì½˜ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ê°œë°œìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
                    </div>
                `;
            }

            if (!diagnostics.swOk) {
                html += `
                    <div class="item warn">
                        <strong>ğŸ”„ Service Worker ì¬ë“±ë¡</strong><br>
                        1. Chrome ì„¤ì • â†’ ì‚¬ì´íŠ¸ ì„¤ì •<br>
                        2. pevjant.github.io ì°¾ê¸°<br>
                        3. "ì €ì¥ê³µê°„ ì§€ìš°ê¸°"<br>
                        4. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    </div>
                `;
            }

            if (html === '') {
                html = '<div class="item ok">âœ… ì¶”ê°€ ì¡°ì¹˜ ë¶ˆí•„ìš”</div>';
            }

            div.innerHTML = html;
        }

        function showDetails() {
            const details = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                isAndroid: diagnostics.isAndroid,
                isChrome: diagnostics.isChrome,
                chromeVersion: diagnostics.chromeVersion,
                isInstalled: diagnostics.isInstalled,
                displayMode: window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser',
                manifestOk: diagnostics.manifestOk,
                iconsOk: diagnostics.iconsOk,
                swOk: diagnostics.swOk,
                errors: diagnostics.errors,
                warnings: diagnostics.warnings,
                url: location.href,
                referrer: document.referrer
            };

            document.getElementById('details').textContent = JSON.stringify(details, null, 2);
        }

        function copyDiagnostics() {
            const text = document.getElementById('details').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('ğŸ“‹ ì§„ë‹¨ ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', runDiagnostics);
    </script>
</body>
</html>
